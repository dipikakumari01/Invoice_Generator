<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> </title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="/public/logo2.png">
    <link rel="apple-touch-icon" href="/public/logo2.png">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>Invoice Records</h1>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="admin.html" class="nav-link">Admin Settings</a>
            <a href="invoice.html" class="nav-link">Create Invoice</a>
            <button class="btn btn-secondary" id="logoutBtn">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>All Invoices</h2>
            <div class="header-actions">
                <input type="text" id="searchInput" placeholder="Search by customer name or invoice no..." class="search-input">
                <input type="date" id="filterDate" class="filter-date">
                <button class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
            </div>
        </div>

        <div class="records-table-container">
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Invoice No</th>
                        <th>Date</th>
                        <th>Customer Name</th>
                        <th>Mobile</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                        <th>Payment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody">
                    <tr>
                        <td colspan="8" class="no-records">No invoices found</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="records-stats">
            <div class="stat-card">
                <h4>Total Invoices</h4>
                <p id="totalInvoices">0</p>
            </div>
            <div class="stat-card">
                <h4>Total Revenue</h4>
                <p id="totalRevenue">₹0.00</p>
            </div>
        </div>
    </div>

    <div id="invoiceDetailModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invoice Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="reprintBtn">Print Invoice</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="printableInvoice" class="printable-invoice" style="display: none;">
        <div class="invoice-watermark"></div>

        <div class="invoice-header">
            <div class="shop-details">
                <h1 id="print-shopName"></h1>
                <p id="print-shopAddress"></p>
                <p>Phone: <span id="print-shopPhone"></span> | Email: <span id="print-shopEmail"></span></p>
                <p>GSTIN: <span id="print-gstin"></span></p>
            </div>
            <div class="invoice-title">
                <h3>TAX INVOICE</h3>
                <p>Invoice No: <strong id="print-invoiceNo"></strong></p>
                <p>Date: <strong id="print-invoiceDate"></strong></p>
            </div>
        </div>

        <div class="customer-details">
            <h3>Bill To:</h3>
            <p><strong id="print-customerName"></strong></p>
            <p id="print-customerAddress"></p>
            <p>Mobile: <span id="print-customerMobile"></span></p>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Item Description</th>
                    <th>Metal/Purity</th>
                    <th>Net Wt (g)</th>
                    <th>Rate (₹/g)</th>
                    <th>Making (₹)</th>
                    <th>Total (₹)</th>
                </tr>
            </thead>
            <tbody id="print-itemsTable"></tbody>
        </table>

        <div class="invoice-footer">
            <div class="payment-details">
                <p>Payment Mode: <strong id="print-paymentMode"></strong></p>
            </div>
            <div class="invoice-totals">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="print-subtotal"></span>
                </div>
                <div class="total-row">
                    <span>CGST (<span id="print-cgstPercent"></span>%):</span>
                    <span id="print-cgst"></span>
                </div>
                <div class="total-row">
                    <span>SGST (<span id="print-sgstPercent"></span>%):</span>
                    <span id="print-sgst"></span>
                </div>
                <div class="total-row grand-total">
                    <span>Grand Total:</span>
                    <span id="print-grandTotal"></span>
                </div>
            </div>
        </div>

    </div>

    <script src="js/app.js"></script>
    <script>
        checkAuthentication();

        const searchInput = document.getElementById('searchInput');
        const filterDate = document.getElementById('filterDate');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const recordsTableBody = document.getElementById('recordsTableBody');
        let allInvoices = [];
        let currentInvoice = null;

        function loadInvoices() {
            allInvoices = getAllInvoices();
            displayInvoices(allInvoices);
            updateStats(allInvoices);
        }

        function displayInvoices(invoices) {
            recordsTableBody.innerHTML = '';

            if (invoices.length === 0) {
                recordsTableBody.innerHTML = '<tr><td colspan="8" class="no-records">No invoices found</td></tr>';
                return;
            }

            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.invoiceNo}</td>
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.customerName}</td>
                    <td>${invoice.customerMobile}</td>
                    <td>${invoice.items.length}</td>
                    <td>₹${invoice.grandTotal.toFixed(2)}</td>
                    <td>${invoice.paymentMode}</td>
                    <td>
                        <button class="btn-action" onclick="viewInvoice('${invoice.invoiceNo}')">View</button>
                        <button class="btn-action" onclick="printInvoice('${invoice.invoiceNo}')">Print</button>
                        <button class="btn-action btn-danger" onclick="deleteInvoice('${invoice.invoiceNo}')">Delete</button>
                    </td>
                `;
                recordsTableBody.appendChild(row);
            });
        }

        function updateStats(invoices) {
            document.getElementById('totalInvoices').textContent = invoices.length;
            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.grandTotal, 0);
            document.getElementById('totalRevenue').textContent = '₹' + totalRevenue.toFixed(2);
        }

        function viewInvoice(invoiceNo) {
            const invoice = allInvoices.find(inv => inv.invoiceNo === invoiceNo);
            if (!invoice) return;

            currentInvoice = invoice;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="invoice-detail">
                    <div class="detail-section">
                        <h4>Invoice Information</h4>
                        <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
                        <p><strong>Date:</strong> ${formatDate(invoice.date)}</p>
                        <p><strong>Payment Mode:</strong> ${invoice.paymentMode}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Customer Details</h4>
                        <p><strong>Name:</strong> ${invoice.customerName}</p>
                        <p><strong>Mobile:</strong> ${invoice.customerMobile}</p>
                        <p><strong>Address:</strong> ${invoice.customerAddress}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Items</h4>
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Metal</th>
                                    <th>Net Wt</th>
                                    <th>Rate</th>
                                    <th>Making</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.metal} ${item.purity}</td>
                                        <td>${item.netWeight.toFixed(3)}g</td>
                                        <td>₹${item.rate.toFixed(2)}</td>
                                        <td>₹${item.making.toFixed(2)}</td>
                                        <td>₹${((item.netWeight * item.rate) + item.making).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="detail-section">
                        <h4>Totals</h4>
                        <p><strong>Subtotal:</strong> ₹${invoice.subtotal.toFixed(2)}</p>
                        <p><strong>CGST:</strong> ₹${invoice.cgst.toFixed(2)}</p>
                        <p><strong>SGST:</strong> ₹${invoice.sgst.toFixed(2)}</p>
                        <p class="grand-total"><strong>Grand Total:</strong> ₹${invoice.grandTotal.toFixed(2)}</p>
                    </div>
                </div>
            `;

            document.getElementById('invoiceDetailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('invoiceDetailModal').style.display = 'none';
        }

        function printInvoice(invoiceNo) {
            const invoice = allInvoices.find(inv => inv.invoiceNo === invoiceNo);
            if (!invoice) return;

            displayPrintableInvoice(invoice);
            setTimeout(() => window.print(), 100);
        }

        function displayPrintableInvoice(invoice) {
            const settings = getShopSettings();

            document.getElementById('print-shopName').textContent = settings.shopName || '';
            document.getElementById('print-shopAddress').textContent = settings.shopAddress || '';
            document.getElementById('print-shopPhone').textContent = settings.shopPhone || '';
            document.getElementById('print-shopEmail').textContent = settings.shopEmail || '';
            document.getElementById('print-gstin').textContent = settings.gstin || '';

            document.getElementById('print-invoiceNo').textContent = invoice.invoiceNo;
            document.getElementById('print-invoiceDate').textContent = formatDate(invoice.date);
            document.getElementById('print-customerName').textContent = invoice.customerName;
            document.getElementById('print-customerAddress').textContent = invoice.customerAddress;
            document.getElementById('print-customerMobile').textContent = invoice.customerMobile;
            document.getElementById('print-paymentMode').textContent = invoice.paymentMode;

            const itemsTableBody = document.getElementById('print-itemsTable');
            itemsTableBody.innerHTML = '';

            invoice.items.forEach(item => {
                const metalValue = item.netWeight * item.rate;
                const total = metalValue + item.making;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sno}</td>
                    <td>${item.name}</td>
                    <td>${item.metal} ${item.purity}</td>
                    <td>${item.netWeight.toFixed(3)}</td>
                    <td>${item.rate.toFixed(2)}</td>
                    <td>${item.making.toFixed(2)}</td>
                    <td>${total.toFixed(2)}</td>
                `;
                itemsTableBody.appendChild(row);
            });

            const gstRate = settings.gstPercentage || 3;
            document.getElementById('print-cgstPercent').textContent = (gstRate / 2).toFixed(2);
            document.getElementById('print-sgstPercent').textContent = (gstRate / 2).toFixed(2);
            document.getElementById('print-subtotal').textContent = '₹' + invoice.subtotal.toFixed(2);
            document.getElementById('print-cgst').textContent = '₹' + invoice.cgst.toFixed(2);
            document.getElementById('print-sgst').textContent = '₹' + invoice.sgst.toFixed(2);
            document.getElementById('print-grandTotal').textContent = '₹' + invoice.grandTotal.toFixed(2);

            document.querySelector('.invoice-watermark').textContent = settings.shopName || 'Jewellery Shop';
        }

        function deleteInvoice(invoiceNo) {
            if (!confirm('Are you sure you want to delete this invoice?')) return;

            const invoices = getAllInvoices();
            const updatedInvoices = invoices.filter(inv => inv.invoiceNo !== invoiceNo);
            localStorage.setItem('invoices', JSON.stringify(updatedInvoices));

            loadInvoices();
        }

        function filterInvoices() {
            const searchTerm = searchInput.value.toLowerCase();
            const dateFilter = filterDate.value;

            let filtered = allInvoices;

            if (searchTerm) {
                filtered = filtered.filter(inv =>
                    inv.customerName.toLowerCase().includes(searchTerm) ||
                    inv.invoiceNo.toLowerCase().includes(searchTerm)
                );
            }

            if (dateFilter) {
                filtered = filtered.filter(inv => inv.date === dateFilter);
            }

            displayInvoices(filtered);
            updateStats(filtered);
        }

        searchInput.addEventListener('input', filterInvoices);
        filterDate.addEventListener('change', filterInvoices);

        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            filterDate.value = '';
            displayInvoices(allInvoices);
            updateStats(allInvoices);
        });

        document.getElementById('reprintBtn').addEventListener('click', () => {
            if (currentInvoice) {
                closeModal();
                printInvoice(currentInvoice.invoiceNo);
            }
        });

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        document.getElementById('logoutBtn').addEventListener('click', logout);

        window.addEventListener('afterprint', () => {
            location.reload();
        });

        loadInvoices();
    </script>
</body>
</html>
